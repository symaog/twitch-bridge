<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Twitch OAuth Bridge</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- on √©vite le cache pour garantir l‚Äôex√©cution -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    html,body{height:100%}
    body{
      margin:0;
      display:flex;align-items:center;justify-content:center;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#0b0d0f;color:#e5f4f2;
    }
    .box{opacity:.9;text-align:center;font-size:14px;line-height:1.45}
    .box strong{display:block;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="box" id="msg" role="status" aria-live="polite">
    <strong>Traitement de l‚Äôautorisation Twitch‚Ä¶</strong>
    Cette fen√™tre va se fermer automatiquement.
  </div>

  <!-- Fallback minimal au cas o√π le script externe ne se charge pas -->
  <script>
    (function () {
      function parseHash() {
        const p = new URLSearchParams(location.hash.replace(/^#/, ''));
        return {
          access_token: p.get('access_token'),
          token_type:   p.get('token_type'),
          scope:       (p.get('scope') || '').split(' ').filter(Boolean),
          state:        p.get('state'),
          expires_in:   p.get('expires_in') ? parseInt(p.get('expires_in'),10) : undefined
        };
      }
      function tryClose() {
        try { window.close(); } catch(_) {}
        // certains navigateurs n√©cessitent ceci
        try { window.open('', '_self'); window.close(); } catch(_) {}
      }
      function sendToOpener(payload, isError) {
        try {
          if (window.opener && window.opener.postMessage) {
            window.opener.postMessage(
              isError ? { type:'twitch_auth_error',  error:String(payload) }
                      : { type:'twitch_auth_success', payload },
              window.location.origin
            );
            setTimeout(tryClose, 150);
            return true;
          }
        } catch(_) {}
        return false;
      }

      if (!location.hash) {
        // Ouverture directe : pas de token ‚Üí on affiche juste un message
        const m = document.getElementById('msg');
        if (m) m.innerHTML = '<strong>Aucun jeton re√ßu.</strong> Vous pouvez fermer cette fen√™tre.';
        return;
      }

      const data = parseHash();
      if (data && data.access_token) {
        const ok = sendToOpener({
          access_token: data.access_token,
          token_type:   data.token_type,
          scope:        data.scope,
          state:        data.state,
          expires_in:   data.expires_in,
          received_at:  Date.now()
        }, false);

        if (!ok) {
          // üîÅ Fallback : aucun opener (Twitch a neutralis√© window.opener)
          // On d√©pose le r√©sultat dans localStorage pour que la page parent le lise
          try {
            localStorage.setItem('symaog_twitch_auth_fallback', JSON.stringify({
              access_token: data.access_token,
              received_at: Date.now()
            }));
          } catch(_) {}

          // ‚ùå Surtout ne pas rediriger vers '/', sinon le site s'ouvre dans la popup.
          // On tente de fermer la fen√™tre. Si le navigateur refuse, on affiche une consigne.
          setTimeout(tryClose, 50);
          const m = document.getElementById('msg');
          if (m) m.innerHTML = '<strong>Autorisation re√ßue.</strong> Vous pouvez fermer cette fen√™tre.';
        }
      }
    })();
  </script>

  <!-- Script complet (validate + /helix/users + postMessage) -->
  <!-- IMPORTANT : ce fichier NE DOIT PAS √™tre inclus dans index.html -->
  <script src="/twitch-auth-bridge-popup.js?v=23" defer></script>

  <noscript>
    <div class="box">
      <strong>JavaScript requis</strong>
      Active JavaScript pour terminer l‚Äôauthentification Twitch.
    </div>
  </noscript>
</body>
</html>
