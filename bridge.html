<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Twitch OAuth Bridge</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    /* Page volontairement minimale ; petit message si la redirection tarde */
    html,body{height:100%} body{display:flex;align-items:center;justify-content:center;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0d0f;color:#e5f4f2}
    .box{opacity:.8;text-align:center;font-size:14px}
    .box strong{display:block;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="box" id="msg" role="status" aria-live="polite">
    <strong>Traitement de l’autorisation Twitch…</strong>
    Cette fenêtre va se fermer automatiquement.
  </div>

  <!--
    Ce script gère :
    - la récupération du token dans l’ancre (#access_token=…)
    - l’envoi du résultat à la fenêtre parente (window.opener)
    - un fallback si la popup est ouverte en plein onglet (sans opener)
  -->
  <script>
    (function () {
      // Si jamais le fichier JS externe ne se charge pas, on implémente un fallback minimal.
      function parseHash() {
        const hash = location.hash.replace(/^#/, '');
        const p = new URLSearchParams(hash);
        return {
          access_token: p.get('access_token'),
          token_type: p.get('token_type'),
          scope: (p.get('scope') || '').split(' ').filter(Boolean),
          state: p.get('state'),
          expires_in: p.get('expires_in') ? parseInt(p.get('expires_in'), 10) : undefined
        };
      }
      function postAndClose(payload, isError) {
        try {
          if (window.opener && window.opener.postMessage) {
            window.opener.postMessage(
              isError ? { type: 'twitch_auth_error',  error: String(payload) }
                      : { type: 'twitch_auth_success', payload },
              window.location.origin
            );
            // Donnons un mini délai au navigateur pour envoyer le message avant fermeture
            setTimeout(() => window.close(), 150);
            return true;
          }
        } catch (_) {}
        return false;
      }

      // Si la page est ouverte “nue” (directement) : petit confort → renvoie vers la home
      function redirectHomeSoon() {
        setTimeout(() => { window.location.replace('/'); }, 800);
      }

      // Si aucune ancre (pas de token), on laisse le script externe gérer (ou on renvoie home)
      if (!location.hash) {
        redirectHomeSoon();
      }

      // Affiche le token localement si jamais opener est indisponible
      const data = parseHash();

      // Si le script externe ne s’exécute pas, on tente un postMessage minimal
      if (data && data.access_token) {
        const ok = postAndClose({
          access_token: data.access_token,
          token_type: data.token_type,
          scope: data.scope,
          state: data.state,
          expires_in: data.expires_in,
          received_at: Date.now()
        }, false);

        if (!ok) {
          // Aucun opener → on stocke en local et on revient à l’origine
          try {
            localStorage.setItem('symaog_twitch_auth_fallback', JSON.stringify({
              access_token: data.access_token,
              received_at: Date.now()
            }));
          } catch (_) {}
          const msg = document.getElementById('msg');
          if (msg) {
            msg.innerHTML = '<strong>Autorisation reçue.</strong> Retour au site…';
          }
          redirectHomeSoon();
        }
      }
    })();
  </script>

  <!-- Script “officiel” du pont (gestion complète, validate + /helix/users, etc.) -->
  <script src="twitch-auth-bridge-popup.js?v=2" defer></script>

  <noscript>
    <div class="box">
      <strong>JavaScript requis</strong>
      Active JavaScript pour terminer l’authentification Twitch.
    </div>
  </noscript>
</body>
</html>
