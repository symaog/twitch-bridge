<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Twitch Bridge</title>
  <style>
    html,body{margin:0;padding:0;background:#0f1115;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:760px;margin:0 auto;padding:18px}
    code{background:#0b0c10;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Twitch Bridge (Popup)</h1>
    <p>Cette page re√ßoit des messages de <code>https://symaog.neocities.org</code>,
       effectue les appels Twitch (<code>/oauth2/validate</code>, <code>/helix/users</code>)
       puis renvoie la r√©ponse via <code>postMessage</code>.</p>
    <pre id="log"></pre>
  </div>

<script>
(() => {
  const ALLOWED_PARENT = "https://symaog.neocities.org";
  const HOST = location.origin;
  const logEl = document.getElementById('log');
  const PARENT = window.opener || window.parent; // popup OU iframe

  function log(...a){ try{ logEl.textContent += a.join(' ') + "\n"; }catch(_){} }
  function reply(win, origin, msg){ try{ win.postMessage(msg, origin); }catch(_){} }

  // Signal READY au parent/ouverture
  try { PARENT && reply(PARENT, ALLOWED_PARENT, { type:"TW_BRIDGE_READY", host: HOST }); } catch(_){}

  async function twValidate(token){
    const r = await fetch("https://id.twitch.tv/oauth2/validate", { headers:{ "Authorization": "OAuth " + token }});
    if(!r.ok) throw new Error("validate failed: " + r.status);
    return await r.json();
  }
  async function twUsers(token, clientId){
    const r = await fetch("https://api.twitch.tv/helix/users", {
      headers:{ "Authorization":"Bearer " + token, "Client-Id": clientId }
    });
    if(!r.ok) throw new Error("users failed: " + r.status);
    return await r.json();
  }

window.addEventListener("message", async (ev) => {
  if (ev.origin !== ALLOWED_PARENT) return; // s√©curit√©
  const msg = ev.data || {};
  if (msg.type !== "TW_BRIDGE_REQ" || !msg.id) return;

  const res = { type:"TW_BRIDGE_RES", id: msg.id, action: msg.action, ok:false };
  try {
    if (msg.action === "validate") {
      res.data = await twValidate(msg.payload.token);
      res.ok = true;
    } else if (msg.action === "users") {
      res.data = await twUsers(msg.payload.token, msg.payload.client_id);
      res.ok = true;
    } else {
      throw new Error("unknown action: " + msg.action);
    }
  } catch (e) {
    res.error = String(e && e.message || e);
  }

  reply(ev.source, ev.origin, res);

  // üîΩ AJOUT ICI
  if (res.ok && msg.action === "users") {
    setTimeout(() => { try { window.close(); } catch(_) {} }, 50);
  }
}, false);
})();
</script>
</body>
</html>

