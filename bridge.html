<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Twitch OAuth Bridge</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Empêcher le cache pour éviter les surprises -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    /* Page volontairement minimale ; petit message si la redirection tarde */
    html,body{height:100%}
    body{
      display:flex;align-items:center;justify-content:center;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#0b0d0f;color:#e5f4f2;margin:0
    }
    .box{opacity:.85;text-align:center;font-size:14px;line-height:1.4}
    .box strong{display:block;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="box" id="msg" role="status" aria-live="polite">
    <strong>Traitement de l’autorisation Twitch…</strong>
    Cette fenêtre va se fermer automatiquement.
  </div>

  <!--
    Fallback MINIMAL : si le script externe ne se charge pas,
    on essaie quand même d'envoyer le résultat au parent ou de revenir à l'accueil.
  -->
  <script>
    (function () {
      function parseHash() {
        const hash = location.hash.replace(/^#/, '');
        const p = new URLSearchParams(hash);
        return {
          access_token: p.get('access_token'),
          token_type: p.get('token_type'),
          scope: (p.get('scope') || '').split(' ').filter(Boolean),
          state: p.get('state'),
          expires_in: p.get('expires_in') ? parseInt(p.get('expires_in'), 10) : undefined
        };
      }
      function postToOpener(payload, isError){
        try{
          if (window.opener && window.opener.postMessage){
            window.opener.postMessage(
              isError ? { type:'twitch_auth_error',  error:String(payload) }
                      : { type:'twitch_auth_success', payload },
              window.location.origin
            );
            setTimeout(()=>window.close(),150);
            return true;
          }
        }catch(_){}
        return false;
      }
      function backHomeSoon(){ setTimeout(()=>location.replace('/'), 800); }

      // Si ouvert sans hash (accès direct) → retourne à l’accueil
      if (!location.hash) { backHomeSoon(); return; }

      const data = parseHash();
      if (data && data.access_token){
        const ok = postToOpener({
          access_token: data.access_token,
          token_type:   data.token_type,
          scope:        data.scope,
          state:        data.state,
          expires_in:   data.expires_in,
          received_at:  Date.now()
        }, false);

        if (!ok){
          // Aucun opener : on stocke puis on revient à l’accueil
          try{
            localStorage.setItem('symaog_twitch_auth_fallback',
              JSON.stringify({ access_token:data.access_token, received_at:Date.now() })
            );
          }catch(_){}
          const msg = document.getElementById('msg');
          if (msg) msg.innerHTML = '<strong>Autorisation reçue.</strong> Retour au site…';
          backHomeSoon();
        }
      }
    })();
  </script>

  <!-- Script “officiel” du pont (validate + /helix/users, envoi au parent) -->
  <!-- IMPORTANT : ce fichier ne doit PAS être inclus dans index.html -->
  <script src="twitch-auth-bridge-popup.js?v=22" defer></script>

  <noscript>
    <div class="box">
      <strong>JavaScript requis</strong>
      Active JavaScript pour terminer l’authentification Twitch.
    </div>
  </noscript>
</body>
</html>
